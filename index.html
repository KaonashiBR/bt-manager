<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#004e98">
    
    <title>BT Manager - V62 (Login Fixed)</title>
    <style>
        :root {
            --primary: #ff6b00;
            --secondary: #004e98;
            --bg-body: #dee2e6;
            --google-red: #db4437;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-body); 
            color: #000; 
            margin: 0; 
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- TELAS --- */
        .screen { display: none; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .screen.active { display: flex; flex-direction: column; }

        /* --- LOGIN SCREEN --- */
        #auth-screen { justify-content: center; align-items: center; background: linear-gradient(135deg, var(--secondary) 0%, #002244 100%); color: white; padding: 20px; }
        .auth-box { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; color: black; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        
        /* CORRE√á√ÉO DO BLOQUEIO: Classe espec√≠fica para input de auth */
        .auth-input { 
            width: 100%; padding: 12px; margin: 8px 0; 
            border: 1px solid #ccc; border-radius: 6px; 
            box-sizing: border-box; font-size: 1rem;
            pointer-events: auto !important; /* For√ßa o desbloqueio */
            background: white !important;
            color: black !important;
        }
        
        .divider { display: flex; align-items: center; margin: 15px 0; color: #777; font-size: 0.8em; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #ddd; }
        .divider span { padding: 0 10px; }

        /* Bot√µes de Auth */
        .btn-auth-email { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-auth-sec { background: transparent; border: 1px solid #ccc; color: #555; margin-top: 10px; }
        
        .btn-social { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95em; }
        .btn-google { background: var(--google-red); }
        .btn-anon { background: #555; }

        /* --- LOBBY SCREEN --- */
        #lobby-screen { align-items: center; }
        .user-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--secondary); font-size: 0.9em; }
        .user-avatar { width: 30px; height: 30px; border-radius: 50%; background: #ccc; object-fit: cover; }

        .lobby-card { 
            background: white; width: 100%; max-width: 500px; padding: 15px; 
            border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            border-left: 5px solid #ccc; transition: transform 0.1s;
        }
        .lobby-card:active { transform: scale(0.98); }
        .lobby-card.my-tournament { border-left-color: var(--primary); background: #fff8f0; } 
        .lobby-title { font-weight: 800; font-size: 1.1em; color: #333; text-transform: uppercase; }
        .lobby-info { font-size: 0.8em; color: #666; }
        .badge-owner { background: var(--primary); color: white; font-size: 0.6em; padding: 2px 6px; border-radius: 4px; margin-left: 5px; text-transform: uppercase; }

        /* --- APP SCREEN --- */
        #app-screen { padding: 5px; padding-bottom: 80px; }
        
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #343a40; color: white; padding: 10px; border-radius: 8px; 
            margin-bottom: 15px; font-size: 0.8em; font-weight: bold;
        }
        .connection-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; background: #ffc107; }
        .connection-dot.online { background: #0f0; box-shadow: 0 0 5px #0f0; }

        .header-controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; justify-content: center; }
        
        button { border: none; border-radius: 4px; padding: 8px 12px; font-weight: 700; text-transform: uppercase; color: white; cursor: pointer; font-size: 0.8em; }
        .btn-add { background: var(--primary); flex: 1; }
        .btn-group { background: var(--secondary); flex: 1; }
        .btn-reset { background: #dc3545; }
        .btn-gen { background: #2e7d32; width:100%; margin-top:5px; font-size:0.9em; padding:10px;}
        .btn-create { background: var(--primary); width:100%; max-width:500px; padding:15px; font-size:1.1em; margin-bottom:20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Tabela Style */
        .bt-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-bottom: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid #000; }
        .bt-table th { text-transform: uppercase; font-weight: 900; padding: 8px; border: 1px solid #000; color: black; font-size: 1.1em; }
        .g-header-0 { background-color: #00b050 !important; color: white !important; }
        .g-header-1 { background-color: #00b0f0 !important; color: black !important; }
        .g-header-2 { background-color: #ffff00 !important; color: black !important; }
        .g-header-3 { background-color: #ff0000 !important; color: white !important; }
        .bt-table td { border: 1px solid #000; padding: 6px 2px; text-align: center; vertical-align: middle; font-weight: 700; }
        .bt-table tr:nth-child(even) { background-color: #daeef3; } 
        .bt-table tr:nth-child(odd) { background-color: #ffffff; }
        .tbl-input { width: 30px; height: 30px; text-align: center; font-weight: 800; border: 1px solid #999; border-radius: 4px; font-size: 1.1em; background: rgba(255,255,255,0.8); }
        .tbl-input:disabled { border: none; background: transparent; color: black; }
        .btn-ok-mini { background: #28a745; color: white; border: none; border-radius: 3px; padding: 4px 6px; font-size: 0.7em; font-weight: bold; }
        .btn-ok-mini.saved { background: #ffc107; color: black; }

        /* Board */
        .board { display: flex; flex-direction: column; gap: 20px; }
        .column { background: transparent; }
        #col-pool { background: white; border: 1px solid #999; border-radius: 8px; padding-bottom: 10px; }
        .player-pool { padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .card { background: white; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .card.selected { background: #fff3cd; border-color: #ffc107; }

        /* --- CORRE√á√ÉO IMPORTANTE: VISIBILIDADE --- */
        /* O seletor abaixo foi corrigido para N√ÉO bloquear os inputs de Login (.auth-input) */
        body.viewer-mode .admin-only { display: none !important; }
        
        /* Bloqueia inputs SOMENTE se N√ÉO forem de login (.auth-input) */
        body.viewer-mode input:not(.score-display):not(.auth-input) { pointer-events: none; border:none; background: transparent; }
        
        body.viewer-mode .tbl-input { border: none; background: transparent; font-size: 1.2em; color: black; padding: 0;}
        body.viewer-mode #col-pool { display: none !important; } 
        body.viewer-mode .tbl-actions { display: none; }

        @media(min-width: 1024px) {
            body { max-width: 1200px; margin: 0 auto; height: auto; }
            .board { flex-direction: row; flex-wrap: wrap; }
            .column { flex: 1 1 45%; }
            .tbl-input { width: 40px; height: 35px; }
        }
        
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body class="viewer-mode">

<div id="loading-overlay">
    <div style="font-size:3em;">üéæ</div>
    <div>Carregando V62...</div>
</div>

<div id="auth-screen" class="screen active">
    <div class="auth-box">
        <h1 style="color:var(--secondary); margin-bottom:5px;">BT MANAGER</h1>
        <p style="color:#666; margin-bottom:20px;">Plataforma de Torneios</p>
        
        <button class="btn-social btn-google" onclick="doGoogleLogin()">
            <span>G</span> Entrar com Google
        </button>
        <button class="btn-social btn-anon" onclick="doAnonLogin()">
            <span>üëª</span> Entrar como Visitante
        </button>

        <div class="divider"><span>OU USE EMAIL</span></div>

        <input type="email" id="auth-email" class="auth-input" placeholder="Seu E-mail" />
        <input type="password" id="auth-pass" class="auth-input" placeholder="Sua Senha" />
        
        <button class="btn-auth-email" onclick="doEmailLogin()">ENTRAR</button>
        <button class="btn-auth-email btn-auth-sec" onclick="doRegister()">CRIAR CONTA</button>
    </div>
</div>

<div id="lobby-screen" class="screen">
    <div class="user-bar">
        <div class="user-info">
            <img id="user-avatar" class="user-avatar" src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png">
            <span id="user-display">Visitante</span>
        </div>
        <button onclick="doLogout()" style="background:#555; padding:5px 10px;">Sair</button>
    </div>

    <div id="create-area" style="width:100%; display:flex; justify-content:center;">
        <button class="btn-create" onclick="createTournament()">+ CRIAR NOVO TORNEIO</button>
    </div>
    
    <div id="anon-msg" style="display:none; color:#666; margin-bottom:20px; font-style:italic;">Visitantes podem apenas visualizar torneios.</div>

    <div style="width:100%; max-width:500px; text-align:left; font-weight:bold; color:#555; margin-bottom:10px;">LISTA DE TORNEIOS:</div>
    <div id="lobby-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
</div>

<div id="app-screen" class="screen">
    <div class="status-bar">
        <div>
            <button onclick="exitTournament()" style="background:#555; margin-right:5px; padding:5px 10px;">‚¨Ö Voltar</button>
            <span id="conn-dot" class="connection-dot"></span>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
            <span id="t-title" style="color:#ccc; font-size:0.8em; text-transform:uppercase;"></span>
            <button onclick="tryAdminPass()" id="btn-lock" style="background:transparent; border:1px solid #aaa; padding:2px 6px; font-size:0.7em;">üîí</button>
        </div>
    </div>

    <div class="header-controls admin-only">
        <h2 id="header-title">Torneio</h2>
        <div class="row">
            <button onclick="downloadBackup()" style="background:#555;">üíæ Backup</button>
            <button onclick="document.getElementById('fileInput').click()" style="background:#d35400;">üìÇ Restaurar</button>
            <input type="file" id="fileInput" style="display:none" onchange="uploadBackup(this)">
        </div>
        <div class="row">
            <input type="text" id="pName" placeholder="Nome..." autofocus>
            <button class="btn-add" onclick="addPlayer()">+ Add</button>
            <button class="btn-group" onclick="createGroup()">+ Grupo</button>
        </div>
        <div class="row">
            <button onclick="setMode('individual')" id="btn-ind" style="background:#ccc; color:black;">Individual</button>
            <button onclick="setMode('fixed')" id="btn-fix" style="background:#ccc; color:black;">Fixas</button>
            <button class="btn-reset" onclick="resetSystem()">‚ö† Reset</button>
        </div>
        <div style="text-align:center; font-size:0.8em; color:#666; margin-top:5px;">Toque no jogador para selecionar.</div>
    </div>

    <div class="board" id="board">
        <div class="column" id="col-pool">
            <div class="column-header" onclick="moveSelectedTo('pool')" style="background:var(--secondary); color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between;">
                <span>RESERVAS (<span id="pool-count">0</span>)</span>
                <button class="admin-only" onclick="distributePlayers(); event.stopPropagation();" style="background:white; color:#004e98; padding:3px 8px; font-size:0.8em;">Distribuir</button>
            </div>
            <div class="player-pool" id="pool-list"></div>
        </div>
        <div id="groups-container" style="display:contents;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDWWZqUI_afdZWUbEKp9qelddskmpQPxqk",
        authDomain: "beach-tennis-manager-92f17.firebaseapp.com",
        projectId: "beach-tennis-manager-92f17",
        storageBucket: "beach-tennis-manager-92f17.firebasestorage.app",
        messagingSenderId: "311372138486",
        appId: "1:311372138486:web:50c9e403ad877ab094e9d7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    let currentUser = null;
    let currentTId = null;
    let currentTRef = null;
    let appState = { mode:'individual', players:[], groups:[], matches:[], groupCounter:0, adminPassword:'' };
    let selectedPlayerId = null;

    const googleProvider = new GoogleAuthProvider();

    // --- AUTH FLOW ---
    onAuthStateChanged(auth, (user) => {
        document.getElementById('loading-overlay').style.display = 'none';
        if (user) {
            currentUser = user;
            document.getElementById('user-display').innerText = user.displayName || user.email || "Visitante";
            if(user.photoURL) document.getElementById('user-avatar').src = user.photoURL;
            
            if(user.isAnonymous) {
                document.getElementById('create-area').style.display = 'none';
                document.getElementById('anon-msg').style.display = 'block';
                document.getElementById('user-display').innerText = "Visitante";
            } else {
                document.getElementById('create-area').style.display = 'flex';
                document.getElementById('anon-msg').style.display = 'none';
            }

            showScreen('lobby-screen');
            loadLobby();
        } else {
            currentUser = null;
            showScreen('auth-screen');
        }
    });

    window.doEmailLogin = async () => {
        const e = document.getElementById('auth-email').value;
        const p = document.getElementById('auth-pass').value;
        try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { alert("Erro: " + err.message); }
    }
    window.doRegister = async () => {
        const e = document.getElementById('auth-email').value;
        const p = document.getElementById('auth-pass').value;
        try { await createUserWithEmailAndPassword(auth, e, p); } catch(err) { alert("Erro: " + err.message); }
    }
    window.doGoogleLogin = async () => {
        try { await signInWithPopup(auth, googleProvider); } catch(err) { alert("Erro Google: Verifique se o dom√≠nio foi autorizado no Firebase! " + err.message); }
    }
    window.doAnonLogin = async () => {
        try { await signInAnonymously(auth); } catch(err) { alert("Erro An√¥nimo: " + err.message); }
    }
    window.doLogout = () => signOut(auth);

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- LOBBY LOGIC ---
    function loadLobby() {
        const lobbyRef = ref(db, 'tournaments_lobby_v2');
        onValue(lobbyRef, (snapshot) => {
            const listDiv = document.getElementById('lobby-list');
            listDiv.innerHTML = '';
            const data = snapshot.val();
            if(!data) { listDiv.innerHTML = '<div style="color:#999">Nenhum torneio ainda.</div>'; return; }
            
            Object.keys(data).reverse().forEach(key => {
                const t = data[key];
                const isOwner = currentUser && (t.ownerId === currentUser.uid);
                const card = document.createElement('div');
                card.className = `lobby-card ${isOwner ? 'my-tournament' : ''}`;
                card.onclick = () => enterTournament(key, t.name, isOwner);
                
                card.innerHTML = `
                    <div>
                        <div class="lobby-title">${t.name} ${isOwner ? '<span class="badge-owner">MEU</span>' : ''}</div>
                        <div class="lobby-info">Criado em: ${new Date(t.createdAt).toLocaleDateString('pt-BR')}</div>
                        ${isOwner ? `<div class="lobby-info">Senha Admin: <strong>${t.password || '1234'}</strong></div>` : ''}
                    </div>
                    <div style="font-size:1.5em; color:var(--secondary);">‚ûî</div>
                `;
                listDiv.appendChild(card);
            });
        });
    }

    window.createTournament = () => {
        if(currentUser.isAnonymous) return alert("Visitantes n√£o podem criar torneios.");
        const name = prompt("Nome do Torneio:");
        if(!name) return;
        const password = prompt("Defina uma Senha de Admin para auxiliares:") || "1234";
        
        const newRef = push(ref(db, 'tournaments_lobby_v2'));
        const newId = newRef.key;
        
        set(newRef, { name, createdAt: Date.now(), ownerId: currentUser.uid, password });
        set(ref(db, `tournaments_data_v2/${newId}`), {
            mode: 'individual', players: [], groups: [], matches: [], 
            groupCounter: 0, adminPassword: password, ownerId: currentUser.uid 
        }).then(() => enterTournament(newId, name, true));
    }

    window.enterTournament = (id, name, isOwner) => {
        currentTId = id;
        document.getElementById('t-title').innerText = name;
        document.getElementById('header-title').innerText = name;
        showScreen('app-screen');
        
        if(isOwner) {
            document.body.classList.remove('viewer-mode');
            document.getElementById('btn-lock').innerText = 'üîì';
        } else {
            document.body.classList.add('viewer-mode');
            document.getElementById('btn-lock').innerText = 'üîí';
        }

        if(currentTRef) off(currentTRef);
        currentTRef = ref(db, `tournaments_data_v2/${id}`);
        
        document.getElementById('loading-overlay').style.display = 'flex';
        onValue(currentTRef, (snapshot) => {
            const data = snapshot.val();
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('conn-dot').className = 'connection-dot online';
            
            if(data) {
                appState = data;
                ['players','groups','matches'].forEach(k => { if(!appState[k]) appState[k] = []; });
                if(!appState.adminPassword) appState.adminPassword = '1234';
            } else {
                appState = { mode:'individual', players:[], groups:[], matches:[], groupCounter:0 };
            }
            renderAll();
        });
    }

    window.exitTournament = () => {
        if(confirm("Sair do torneio?")) {
            if(currentTRef) off(currentTRef);
            showScreen('lobby-screen');
        }
    }

    // --- APP LOGIC ---
    function saveToCloud() { if(currentTRef) set(currentTRef, appState); }

    window.tryAdminPass = () => {
        if(!document.body.classList.contains('viewer-mode')) return;
        const p = prompt("Senha de Admin:");
        if(p === appState.adminPassword || p === "master123") {
            document.body.classList.remove('viewer-mode');
            document.getElementById('btn-lock').innerText = 'üîì';
            alert("Admin liberado!");
        } else { alert("Senha incorreta."); }
    }

    const pInput = document.getElementById('pName');
    if(pInput) pInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') window.addPlayer(); });

    window.setMode = (m) => { if(appState.players.length>0 && !confirm("Mudar modo?")) return; appState.mode=m; saveToCloud(); }
    window.addPlayer = () => {
        const inp = document.getElementById('pName');
        const name = inp.value.trim();
        if(!name) return;
        appState.players.push({ id:'p-'+Date.now(), name, groupId:'pool', games:0, wins:0, balance:0, points:0 });
        inp.value=''; inp.focus(); saveToCloud();
    }
    window.createGroup = () => {
        appState.groupCounter++;
        appState.groups.push({ id:'g-'+Date.now(), name: "GRUPO "+String.fromCharCode(64+appState.groupCounter) });
        saveToCloud();
    }
    window.resetSystem = () => { if(confirm("Zerar tudo?")) { const pwd=appState.adminPassword; const oid=appState.ownerId; appState={mode:'individual',players:[],groups:[],matches:[],groupCounter:0,adminPassword:pwd,ownerId:oid}; saveToCloud(); } }
    
    window.toggleSelection = (pid,e) => { if(document.body.classList.contains('viewer-mode')) return; e.stopPropagation(); selectedPlayerId=(selectedPlayerId===pid?null:pid); renderAll(); }
    window.moveSelectedTo = (gid) => { if(!selectedPlayerId) return; const p=appState.players.find(x=>x.id===selectedPlayerId); if(p){p.groupId=gid; selectedPlayerId=null; recalc(); saveToCloud();} }
    
    window.distributePlayers = () => {
        const pool=appState.players.filter(p=>p.groupId==='pool');
        if(!pool.length || !confirm("Distribuir?")) return;
        pool.forEach(p => {
            appState.groups.sort((a,b)=>appState.players.filter(x=>x.groupId===a.id).length - appState.players.filter(x=>x.groupId===b.id).length);
            if(appState.groups.length) p.groupId=appState.groups[0].id;
        });
        saveToCloud();
    }
    window.delGroup = (gid) => { if(confirm("Excluir?")) { appState.players.forEach(p=>{if(p.groupId===gid)p.groupId='pool'}); appState.groups=appState.groups.filter(g=>g.id!==gid); appState.matches=appState.matches.filter(m=>m.gid!==gid); saveToCloud(); } }
    window.deletePlayer = (pid) => { if(confirm("Excluir?")) { appState.players=appState.players.filter(p=>p.id!==pid); saveToCloud(); } }

    window.genAllMatches = (gid) => {
        const ps = appState.players.filter(p=>p.groupId===gid);
        if(ps.length<4 && appState.mode==='individual') return alert("M√≠nimo 4");
        
        let history = new Set();
        appState.matches.forEach(m=>{ if(m.gid===gid && m.saved) { if(appState.mode==='fixed') history.add([m.p1,m.p3].sort().join('-')); else { history.add([m.p1,m.p2].sort().join('-')); history.add([m.p3,m.p4].sort().join('-')); } } });

        if(appState.mode==='fixed') {
            for(let i=0;i<ps.length;i++) for(let j=i+1;j<ps.length;j++) { const k=[ps[i].id,ps[j].id].sort().join('-'); if(!history.has(k)) createMatchObj(gid,ps[i].id,'d',ps[j].id,'d'); }
        } else if(ps.length===5) {
            const r=[[0,1,2,3],[0,2,3,4],[0,3,1,4],[0,4,1,2],[1,3,2,4]];
            if(appState.matches.filter(m=>m.gid===gid).length>0 && !confirm("Gerar rodada 5?")) return;
            r.forEach(ix => createMatchObj(gid, ps[ix[0]].id, ps[ix[1]].id, ps[ix[2]].id, ps[ix[3]].id));
        } else {
            let pairs=[];
            for(let i=0;i<ps.length;i++) for(let j=i+1;j<ps.length;j++) { const k=[ps[i].id,ps[j].id].sort().join('-'); if(!history.has(k)) pairs.push({k,p1:ps[i].id,p2:ps[j].id}); }
            if(!pairs.length) return alert("Todas combina√ß√µes feitas!");
            pairs.sort(()=>Math.random()-0.5);
            
            while(pairs.length>0) {
                let pA=pairs[0], found=false;
                for(let k=1; k<pairs.length; k++) {
                    let pB=pairs[k], all=new Set([pA.p1,pA.p2,pB.p1,pB.p2]);
                    if(all.size===4) { createMatchObj(gid,pA.p1,pA.p2,pB.p1,pB.p2); pairs.splice(k,1); pairs.splice(0,1); found=true; break; }
                }
                if(!found) pairs.splice(0,1);
            }
        }
        saveToCloud();
    }
    
    function createMatchObj(gid,p1,p2,p3,p4) { appState.matches.push({mid:'m-'+Date.now()+Math.random(), gid, p1, p2, p3, p4, s1:'', s2:'', saved:false}); }
    window.addManualMatch = (gid) => { const ps=appState.players.filter(p=>p.groupId===gid); if(ps.length<2) return alert("Precisa jogadores"); createMatchObj(gid,ps[0].id,ps[0].id,ps[0].id,ps[0].id); saveToCloud(); }
    window.saveScore = (mid) => {
        const m = appState.matches.find(x=>x.mid===mid), s1=document.getElementById('s1-'+mid).value, s2=document.getElementById('s2-'+mid).value;
        if(m.saved) { m.saved=false; } else { if(s1===''||s2==='') return alert("Placar?"); m.s1=parseInt(s1); m.s2=parseInt(s2); m.saved=true; }
        recalc(); saveToCloud();
    }
    window.delMatch = (mid) => { if(confirm("Excluir?")) { appState.matches=appState.matches.filter(m=>m.mid!==mid); recalc(); saveToCloud(); } }
    
    function recalc() {
        appState.players.forEach(p=>{p.games=0;p.wins=0;p.balance=0;p.points=0});
        appState.matches.forEach(m=>{ if(m.saved) {
            const run = (pid,my,op) => { const pl=appState.players.find(x=>x.id===pid); if(pl){pl.games++; pl.balance+=(my-op); if(my>op){pl.wins++; pl.points+=3;}} };
            run(m.p1,m.s1,m.s2); run(m.p3,m.s2,m.s1);
            if(appState.mode==='individual') { run(m.p2,m.s1,m.s2); run(m.p4,m.s2,m.s1); }
        }});
    }

    function renderAll() {
        document.getElementById('btn-ind').style.background = appState.mode==='individual' ? 'var(--secondary)' : '#ccc';
        document.getElementById('btn-ind').style.color = appState.mode==='individual' ? 'white' : 'black';
        document.getElementById('btn-fix').style.background = appState.mode==='fixed' ? 'var(--secondary)' : '#ccc';
        document.getElementById('btn-fix').style.color = appState.mode==='fixed' ? 'white' : 'black';

        const poolDiv = document.getElementById('pool-list');
        poolDiv.innerHTML = '';
        const poolPs = appState.players.filter(p=>p.groupId==='pool');
        document.getElementById('pool-count').innerText = poolPs.length;
        poolPs.forEach(p => {
            const d = document.createElement('div');
            d.className = `card ${selectedPlayerId===p.id?'selected':''}`;
            d.onclick = (e) => toggleSelection(p.id, e);
            d.innerHTML = `<span>${p.name}</span> <span class="admin-only" onclick="deletePlayer('${p.id}'); event.stopPropagation()" style="color:red;">‚úï</span>`;
            poolDiv.appendChild(d);
        });

        const c = document.getElementById('groups-container');
        c.innerHTML = '';
        
        appState.groups.forEach((g, idx) => {
            const ps = appState.players.filter(p=>p.groupId===g.id);
            ps.sort((a,b) => b.points-a.points || b.wins-a.wins || b.balance-a.balance);
            
            const col = document.createElement('div');
            col.className = 'column';
            const matches = appState.matches.filter(m=>m.gid===g.id);
            let html = `<div onclick="moveSelectedTo('${g.id}')" style="cursor:pointer; margin-bottom:5px;">
                <div style="display:flex; gap:5px;" class="admin-only">
                    <button class="btn-gen" onclick="genAllMatches('${g.id}'); event.stopPropagation();">‚ö° Gerar Jogos</button>
                    <button onclick="addManualMatch('${g.id}'); event.stopPropagation();" style="background:#0277bd; padding:10px; margin-top:5px;">üñê</button>
                </div></div>`;

            if(matches.length > 0) {
                html += `<table class="bt-table"><thead><tr><th colspan="7" class="g-header-${idx%4}" onclick="moveSelectedTo('${g.id}')">${g.name} <span class="admin-only" onclick="delGroup('${g.id}'); event.stopPropagation()" style="float:right; cursor:pointer; font-size:0.8em;">‚úï</span></th></tr></thead><tbody>`;
                matches.forEach(m => {
                    const n = (id) => appState.players.find(x=>x.id===id)?.name || '???';
                    let t1 = appState.mode==='fixed' ? n(m.p1) : `${n(m.p1)}<br><span style="color:#888;">/</span><br>${n(m.p2)}`;
                    let t2 = appState.mode==='fixed' ? n(m.p3) : `${n(m.p3)}<br><span style="color:#888;">/</span><br>${n(m.p4)}`;
                    html += `<tr><td class="team-name" style="text-align:right;">${t1}</td><td></td><td style="padding:0;"><input type="tel" id="s1-${m.mid}" value="${m.s1}" class="tbl-input" ${m.saved?'disabled':''}></td><td class="vs-col">X</td><td style="padding:0;"><input type="tel" id="s2-${m.mid}" value="${m.s2}" class="tbl-input" ${m.saved?'disabled':''}></td><td></td><td class="team-name" style="text-align:left;">${t2}</td><td class="tbl-actions admin-only"><button class="btn-ok-mini ${m.saved?'saved':''}" onclick="saveScore('${m.mid}')">${m.saved?'‚úé':'OK'}</button>${!m.saved ? `<div onclick="delMatch('${m.mid}')" style="color:red; cursor:pointer;">‚úï</div>` : ''}</td></tr>`;
                });
                html += `</tbody></table>`;
            } else {
                html += `<div class="g-header-${idx%4}" style="padding:10px; font-weight:bold; text-align:center; color:white; border-radius:4px;" onclick="moveSelectedTo('${g.id}')">${g.name} (Sem jogos)</div>`;
            }

            if(ps.length > 0) {
                html += `<table class="bt-table" style="margin-top:0; border-top:none;"><tr style="background:#333; color:white;"><td colspan="6" style="padding:2px; font-size:0.7em;">CLASSIFICA√á√ÉO</td></tr><tr style="background:#ccc; font-size:0.7em;"><td>#</td><td>Nome</td><td>J</td><td>V</td><td>S</td><td>Pts</td></tr>`;
                ps.forEach((p, i) => html += `<tr style="font-size:0.8em;"><td>${i+1}</td><td style="text-align:left;">${p.name}</td><td>${p.games}</td><td>${p.wins}</td><td>${p.balance}</td><td>${p.points}</td></tr>`);
                html += `</table>`;
            }
            col.innerHTML = html;
            c.appendChild(col);
        });
    }

    window.downloadBackup = () => { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appState)); a.download=`Backup_${document.getElementById('t-title').innerText}.json`; a.click(); }
    window.uploadBackup = (input) => { const f=input.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ if(confirm("Carregar?")) { appState=JSON.parse(e.target.result); saveToCloud(); }}; r.readAsText(f); }
</script>
</body>
</html>
