<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#004e98">
    
    <title>BT Manager - V55 (Visual Tabela)</title>
    <style>
        :root {
            --primary: #ff6b00;
            --secondary: #004e98;
            --bg-body: #dee2e6;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-body); 
            color: #000; 
            padding: 10px; margin: 0; padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- VISIBILIDADE --- */
        body.viewer-mode .admin-only { display: none !important; }
        body.viewer-mode input:not(.score-display) { pointer-events: none; border:none; background: transparent; }
        body.viewer-mode .tbl-input { border: none; background: transparent; font-size: 1.2em; color: black; padding: 0;}
        body.viewer-mode #col-pool { display: none !important; } 
        body.viewer-mode .del-btn { display: none; }
        body.viewer-mode .tbl-actions { display: none; }

        /* --- ESTILO TABELA (Igual Imagem) --- */
        .bt-table { 
            width: 100%; border-collapse: collapse; font-size: 0.85rem; 
            margin-bottom: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid #000;
        }
        
        .bt-table th { 
            text-transform: uppercase; font-weight: 900; padding: 8px; 
            border: 1px solid #000; color: black; font-size: 1.1em;
        }
        
        /* Cores dos Grupos (Ciclo: Verde, Azul, Amarelo, Vermelho) */
        .g-header-0 { background-color: #00b050 !important; color: white !important; }
        .g-header-1 { background-color: #00b0f0 !important; color: black !important; }
        .g-header-2 { background-color: #ffff00 !important; color: black !important; }
        .g-header-3 { background-color: #ff0000 !important; color: white !important; }

        .bt-table td { 
            border: 1px solid #000; padding: 6px 2px; text-align: center; 
            vertical-align: middle; font-weight: 700;
        }

        /* Linhas Zebradas (Azulzinho e Branco) */
        .bt-table tr:nth-child(even) { background-color: #daeef3; } 
        .bt-table tr:nth-child(odd) { background-color: #ffffff; }
        
        /* Inputs na Tabela */
        .tbl-input { 
            width: 28px; height: 28px; text-align: center; font-weight: 800; 
            border: 1px solid #999; border-radius: 4px; font-size: 1.1em; margin: 0 1px;
            background: rgba(255,255,255,0.8);
        }
        .tbl-input:disabled { border: none; background: transparent; color: black; }

        .team-name { font-size: 0.95em; line-height: 1.1; max-width: 100px; word-wrap: break-word; }
        .vs-col { font-size: 0.8em; color: #555; font-weight: 900; padding: 0 2px !important; }
        
        /* BotÃ£o Salvar Pequeno na Tabela */
        .btn-ok-mini { 
            background: #28a745; color: white; border: none; border-radius: 3px; 
            padding: 4px 6px; font-size: 0.7em; font-weight: bold; cursor: pointer;
        }
        .btn-ok-mini.saved { background: #ffc107; color: black; }

        /* --- RESTO DO LAYOUT (V54) --- */
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #343a40; color: white; padding: 10px; border-radius: 8px; 
            margin-bottom: 15px; font-size: 0.8em; font-weight: bold;
        }
        .connection-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; background: #ffc107; }
        .connection-dot.online { background: #0f0; box-shadow: 0 0 5px #0f0; }

        .header-controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; justify-content: center; }
        h2 { margin: 0; text-align: center; text-transform: uppercase; font-size: 1.4em; width: 100%; margin-bottom: 10px; }
        
        button { 
            border: none; border-radius: 4px; padding: 8px 12px; font-weight: 700; 
            text-transform: uppercase; color: white; cursor: pointer; font-size: 0.8em;
        }
        .btn-add { background: var(--primary); flex: 1; }
        .btn-group { background: var(--secondary); flex: 1; }
        .btn-reset { background: #dc3545; }
        .btn-gen { background: #2e7d32; width:100%; margin-top:5px;}
        
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex: 1; font-weight: bold; }

        /* Board & Columns */
        .board { display: flex; flex-direction: column; gap: 20px; }
        .column { background: transparent; } /* Transparente pois a tabela jÃ¡ tem estilo */
        
        /* Reservas Ã© diferente, mantÃ©m estilo card */
        #col-pool { background: white; border: 1px solid #999; border-radius: 8px; overflow: hidden; padding-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #col-pool .column-header { background: var(--secondary); color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .player-pool { padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .card { background: white; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .card.selected { background: #fff3cd; border-color: #ffc107; }

        /* Media Query PC */
        @media(min-width: 1024px) {
            body { max-width: 1200px; margin: 0 auto; }
            .board { flex-direction: row; flex-wrap: wrap; }
            .column { flex: 1 1 45%; }
            .bt-table { font-size: 1rem; }
            .tbl-input { width: 40px; height: 35px; }
        }
        
        /* Loading */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body class="viewer-mode">

<div id="loading-overlay">
    <div style="font-size:3em;">ðŸŽ¾</div>
    <div><strong>Carregando Tabela V55...</strong></div>
</div>

<div class="status-bar">
    <div><span id="conn-dot" class="connection-dot"></span> <span id="conn-text">CONECTANDO</span></div>
    <button onclick="toggleAdmin()" style="background:transparent; border:1px solid #aaa; padding:2px 6px; font-size:0.7em;">ðŸ”’</button>
</div>

<div class="header-controls admin-only">
    <h2>Beach Tennis Manager</h2>
    <div class="row">
        <button onclick="downloadBackup()" style="background:#555;">ðŸ’¾ Backup</button>
        <button onclick="document.getElementById('fileInput').click()" style="background:#d35400;">ðŸ“‚ Restaurar</button>
        <input type="file" id="fileInput" style="display:none" onchange="uploadBackup(this)">
    </div>
    <div class="row">
        <input type="text" id="pName" placeholder="Nome do Jogador..." autofocus>
        <button class="btn-add" onclick="addPlayer()">+ Add</button>
        <button class="btn-group" onclick="createGroup()">+ Grupo</button>
    </div>
    <div class="row">
        <button onclick="setMode('individual')" id="btn-ind" style="background:#ccc; color:black;">Individual</button>
        <button onclick="setMode('fixed')" id="btn-fix" style="background:#ccc; color:black;">Fixas</button>
        <button class="btn-reset" onclick="resetSystem()">âš  Reset</button>
    </div>
    <div style="text-align:center; font-size:0.8em; color:#666; margin-top:5px;">Toque no jogador para selecionar.</div>
</div>

<div class="board" id="board">
    <div class="column" id="col-pool">
        <div class="column-header" onclick="moveSelectedTo('pool')">
            <span>RESERVAS (<span id="pool-count">0</span>)</span>
            <button class="admin-only" onclick="distributePlayers(); event.stopPropagation();" style="background:white; color:#004e98; padding:3px 8px; font-size:0.8em;">Distribuir</button>
        </div>
        <div class="player-pool" id="pool-list"></div>
    </div>
    
    <div id="groups-container" style="display:contents;"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDWWZqUI_afdZWUbEKp9qelddskmpQPxqk",
        authDomain: "beach-tennis-manager-92f17.firebaseapp.com",
        projectId: "beach-tennis-manager-92f17",
        storageBucket: "beach-tennis-manager-92f17.firebasestorage.app",
        messagingSenderId: "311372138486",
        appId: "1:311372138486:web:50c9e403ad877ab094e9d7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'tournament_v55'); // NOVA CHAVE V55

    let appState = { mode: 'individual', players: [], groups: [], matches: [], groupCounter: 0 };
    let selectedPlayerId = null;

    // --- INPUT ENTER KEY ---
    const pInput = document.getElementById('pName');
    if(pInput) {
        pInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') window.addPlayer();
        });
    }

    // --- SYNC ---
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        document.getElementById('loading-overlay').style.display = 'none';
        const dot = document.getElementById('conn-dot');
        const txt = document.getElementById('conn-text');
        dot.className = 'connection-dot online'; txt.innerText = 'ONLINE';

        if (data) {
            appState = data;
            if(!appState.players) appState.players = [];
            if(!appState.groups) appState.groups = [];
            if(!appState.matches) appState.matches = [];
        } else {
            appState = { mode:'individual', players: [], groups: [], matches: [], groupCounter: 0 };
        }
        renderAll();
    }, (err) => { alert("Erro Rede: " + err.message); });

    function saveToCloud() { set(dbRef, appState); }

    // --- ACTIONS ---
    window.toggleAdmin = function() {
        if(document.body.classList.contains('viewer-mode')) {
            if(prompt("Senha:")==="1234") document.body.classList.remove('viewer-mode');
        } else {
            document.body.classList.add('viewer-mode');
        }
    }

    window.setMode = function(m) {
        if(appState.players.length>0 && !confirm("Mudar modo?")) return;
        appState.mode = m; saveToCloud();
    }

    window.addPlayer = function() {
        const inp = document.getElementById('pName');
        const name = inp.value.trim();
        if(!name) return;
        appState.players.push({ id: 'p-'+Date.now(), name: name, groupId: 'pool', games:0, wins:0, balance:0, points:0 });
        inp.value = ''; inp.focus(); saveToCloud();
    }

    window.createGroup = function() {
        appState.groupCounter++;
        appState.groups.push({ id: 'g-'+Date.now(), name: "GRUPO "+String.fromCharCode(64+appState.groupCounter) }); // Gera A, B, C...
        saveToCloud();
    }

    window.resetSystem = function() {
        if(confirm("Zerar tudo?")) { appState={mode:'individual',players:[],groups:[],matches:[],groupCounter:0}; saveToCloud(); }
    }

    window.toggleSelection = function(pid, e) {
        if(document.body.classList.contains('viewer-mode')) return;
        e.stopPropagation();
        selectedPlayerId = (selectedPlayerId === pid) ? null : pid;
        renderAll();
    }

    window.moveSelectedTo = function(gid) {
        if(!selectedPlayerId) return;
        const p = appState.players.find(x=>x.id===selectedPlayerId);
        if(p) { p.groupId = gid; selectedPlayerId = null; recalc(); saveToCloud(); }
    }

    window.distributePlayers = function() {
        const pool = appState.players.filter(p=>p.groupId==='pool');
        if(!pool.length || !confirm("Distribuir?")) return;
        pool.forEach(p => {
            appState.groups.sort((a,b) => appState.players.filter(x=>x.groupId===a.id).length - appState.players.filter(x=>x.groupId===b.id).length);
            if(appState.groups.length) p.groupId = appState.groups[0].id;
        });
        saveToCloud();
    }

    window.delGroup = function(gid) {
        if(confirm("Excluir Grupo?")) {
            appState.players.forEach(p=>{if(p.groupId===gid) p.groupId='pool'});
            appState.groups = appState.groups.filter(g=>g.id!==gid);
            appState.matches = appState.matches.filter(m=>m.gid!==gid);
            saveToCloud();
        }
    }
    
    window.deletePlayer = function(pid) {
        if(confirm("Excluir jogador?")) { appState.players = appState.players.filter(p=>p.id!==pid); saveToCloud(); }
    }

    // --- MATCH LOGIC ---
    window.genMatches = function(gid) {
        const ps = appState.players.filter(p=>p.groupId===gid);
        if(ps.length<4 && appState.mode==='individual') return alert("MÃ­nimo 4");
        
        // Simple Logic for V55 demo (Robust logic from V45 can be pasted here if needed)
        // Creating random match for demonstration of table style
        let m = { mid:'m-'+Date.now(), gid:gid, s1:'', s2:'', saved:false };
        
        if(appState.mode==='fixed') {
             if(ps.length<2) return;
             m.p1 = ps[0].id; m.p2 = 'dummy'; m.p3 = ps[1].id; m.p4 = 'dummy';
        } else {
             if(ps.length<4) return;
             m.p1 = ps[0].id; m.p2 = ps[1].id; m.p3 = ps[2].id; m.p4 = ps[3].id;
        }
        appState.matches.push(m);
        saveToCloud();
    }

    window.saveScore = function(mid) {
        const m = appState.matches.find(x=>x.mid===mid);
        const s1 = document.getElementById('s1-'+mid).value;
        const s2 = document.getElementById('s2-'+mid).value;
        if(m.saved) {
            m.saved = false;
        } else {
            if(s1==='' || s2==='') return alert("Placar?");
            m.s1 = parseInt(s1); m.s2 = parseInt(s2); m.saved = true;
        }
        recalc(); saveToCloud();
    }

    window.delMatch = function(mid) {
        if(confirm("Excluir jogo?")) { appState.matches = appState.matches.filter(m=>m.mid!==mid); recalc(); saveToCloud(); }
    }

    function recalc() {
        appState.players.forEach(p=>{p.games=0; p.wins=0; p.balance=0; p.points=0;});
        appState.matches.forEach(m=>{
            if(m.saved) {
                const run = (pid, my, op) => {
                    const pl = appState.players.find(x=>x.id===pid);
                    if(pl) { pl.games++; pl.balance+=(my-op); if(my>op){pl.wins++; pl.points+=3;} }
                };
                run(m.p1,m.s1,m.s2); run(m.p3,m.s2,m.s1);
                if(appState.mode==='individual') { run(m.p2,m.s1,m.s2); run(m.p4,m.s2,m.s1); }
            }
        });
    }

    // --- RENDER TABLE STYLE ---
    function renderAll() {
        document.getElementById('btn-ind').style.background = appState.mode==='individual' ? 'var(--secondary)' : '#ccc';
        document.getElementById('btn-ind').style.color = appState.mode==='individual' ? 'white' : 'black';
        document.getElementById('btn-fix').style.background = appState.mode==='fixed' ? 'var(--secondary)' : '#ccc';
        document.getElementById('btn-fix').style.color = appState.mode==='fixed' ? 'white' : 'black';

        // Pool
        const poolDiv = document.getElementById('pool-list');
        poolDiv.innerHTML = '';
        const poolPs = appState.players.filter(p=>p.groupId==='pool');
        document.getElementById('pool-count').innerText = poolPs.length;
        poolPs.forEach(p => {
            const d = document.createElement('div');
            d.className = `card ${selectedPlayerId===p.id?'selected':''}`;
            d.onclick = (e) => toggleSelection(p.id, e);
            d.innerHTML = `<span>${p.name}</span> <span class="admin-only" onclick="deletePlayer('${p.id}'); event.stopPropagation()" style="color:red;">âœ•</span>`;
            poolDiv.appendChild(d);
        });

        // Groups
        const c = document.getElementById('groups-container');
        c.innerHTML = '';
        
        appState.groups.forEach((g, idx) => {
            const ps = appState.players.filter(p=>p.groupId===g.id);
            ps.sort((a,b) => b.points-a.points || b.wins-a.wins || b.balance-a.balance);
            
            // Header Color Cycle
            const colorClass = `g-header-${idx % 4}`;

            const col = document.createElement('div');
            col.className = 'column';
            
            // 1. Group Header (Click to receive player)
            let html = `
                <div onclick="moveSelectedTo('${g.id}')" style="cursor:pointer; margin-bottom:5px;">
                    <button class="btn-gen admin-only" onclick="genMatches('${g.id}'); event.stopPropagation();">âš¡ Novo Jogo (Auto)</button>
                </div>
            `;

            // 2. MATCH TABLE
            const matches = appState.matches.filter(m=>m.gid===g.id);
            if(matches.length > 0) {
                html += `<table class="bt-table">
                    <thead>
                        <tr><th colspan="7" class="${colorClass}" onclick="moveSelectedTo('${g.id}')">${g.name} <span class="admin-only" onclick="delGroup('${g.id}'); event.stopPropagation()" style="float:right; cursor:pointer; font-size:0.8em;">âœ•</span></th></tr>
                    </thead>
                    <tbody>`;
                
                matches.forEach(m => {
                    const n = (id) => appState.players.find(x=>x.id===id)?.name || '???';
                    // Layout: Team 1 | Score X Score | Team 2
                    // Names Stacked
                    let t1 = appState.mode==='fixed' ? n(m.p1) : `${n(m.p1)}<br><span style="color:#888;">/</span><br>${n(m.p2)}`;
                    let t2 = appState.mode==='fixed' ? n(m.p3) : `${n(m.p3)}<br><span style="color:#888;">/</span><br>${n(m.p4)}`;
                    
                    html += `
                    <tr>
                        <td class="team-name" style="text-align:right;">${t1}</td>
                        <td style="width:5px; border-right:none;"></td>
                        <td style="width:35px; padding:0;">
                            <input type="tel" id="s1-${m.mid}" value="${m.s1}" class="tbl-input" ${m.saved?'disabled':''}>
                        </td>
                        <td class="vs-col">X</td>
                        <td style="width:35px; padding:0;">
                            <input type="tel" id="s2-${m.mid}" value="${m.s2}" class="tbl-input" ${m.saved?'disabled':''}>
                        </td>
                        <td style="width:5px; border-left:none;"></td>
                        <td class="team-name" style="text-align:left;">${t2}</td>
                        
                        <td class="tbl-actions admin-only" style="width:40px;">
                            <button class="btn-ok-mini ${m.saved?'saved':''}" onclick="saveScore('${m.mid}')">${m.saved?'âœŽ':'OK'}</button>
                            ${!m.saved ? `<div onclick="delMatch('${m.mid}')" style="color:red; cursor:pointer; font-size:1.2em; margin-top:5px;">âœ•</div>` : ''}
                        </td>
                    </tr>`;
                });
                html += `</tbody></table>`;
            } else {
                // Empty state header
                html += `<div class="${colorClass}" style="padding:10px; font-weight:bold; text-align:center; color:white; border-radius:4px;" onclick="moveSelectedTo('${g.id}')">${g.name} (Sem jogos)</div>`;
            }

            // 3. RANKING TABLE (Simplified below matches)
            if(ps.length > 0) {
                html += `<table class="bt-table" style="margin-top:0; border-top:none;">
                    <tr style="background:#333; color:white;"><td colspan="6" style="padding:2px; font-size:0.7em;">CLASSIFICAÃ‡ÃƒO</td></tr>
                    <tr style="background:#ccc; font-size:0.7em;"><td>#</td><td>Nome</td><td>J</td><td>V</td><td>S</td><td>Pts</td></tr>
                `;
                ps.forEach((p, i) => {
                    html += `<tr style="font-size:0.8em;">
                        <td>${i+1}</td><td style="text-align:left;">${p.name}</td><td>${p.games}</td><td>${p.wins}</td><td>${p.balance}</td><td>${p.points}</td>
                    </tr>`;
                });
                html += `</table>`;
            }

            col.innerHTML = html;
            c.appendChild(col);
        });
    }

    // Backup Functions
    window.downloadBackup = function() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState));
        a.download = "BT_Backup_V55.json"; a.click();
    }
    window.uploadBackup = function(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => { if(confirm("Carregar?")) { appState=JSON.parse(e.target.result); saveToCloud(); }};
        r.readAsText(f);
    }
</script>
</body>
</html>
