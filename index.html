<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#004e98">
    
    <title>BT Arena - V70 (Corre√ß√£o Imagens)</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #ff6b00;
            --secondary: #004e98;
            --bg-body: #f4f6f8;
            --text-dark: #333;
            --blue-masc: #2196F3;
            --pink-fem: #E91E63;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-body); color: var(--text-dark); margin: 0; 
            -webkit-tap-highlight-color: transparent; height: 100vh; display: flex; flex-direction: column;
        }

        /* NAVBAR */
        .navbar { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 100; }
        .nav-logo { font-weight: 900; font-size: 1.2em; color: var(--secondary); letter-spacing: -0.5px; }
        .nav-user { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px; border-radius: 20px; transition: background 0.2s; }
        .nav-user:active { background: #eee; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #ddd; object-fit: cover; }
        .user-name { font-size: 0.85em; font-weight: 600; color: #555; display: none; }
        @media(min-width: 600px) { .user-name { display: block; } }

        /* TELAS */
        .screen { display: none; flex: 1; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .screen.active { display: flex; flex-direction: column; }

        /* GRID CARDS */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 1.5em; font-weight: 800; color: #222; margin: 0; }
        .back-btn { display: flex; align-items: center; gap: 5px; color: #666; cursor: pointer; font-weight: 600; font-size: 0.9em; margin-bottom: 15px;}

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; width: 100%; }
        
        .std-card {
            background: white; border-radius: 12px; overflow: hidden; position: relative;
            aspect-ratio: 1 / 1; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;
        }
        .std-card:active { transform: scale(0.97); }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 30px 10px 10px; color: white;
        }
        .card-title { font-weight: 700; font-size: 1.1em; text-shadow: 0 1px 3px rgba(0,0,0,0.8); line-height: 1.2; }
        .card-subtitle { font-size: 0.75em; opacity: 0.8; margin-top: 2px; }
        
        /* CATEGORIA VISUAL */
        .cat-card-content { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; color: white; font-weight: 900; font-size: 4em; text-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
        .bg-masc { background: var(--blue-masc); }
        .bg-fem { background: var(--pink-fem); }
        .bg-mista { background: linear-gradient(135deg, var(--blue-masc) 50%, var(--pink-fem) 50%); }

        /* A√á√ïES CARD */
        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; }
        .btn-icon-circle {
            width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.9);
            color: #333; display: flex; justify-content: center; align-items: center;
            font-size: 1.2em; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;
        }

        .btn-add-float {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
            background: var(--primary); color: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 2em; box-shadow: 0 4px 10px rgba(255, 107, 0, 0.4);
            border: none; cursor: pointer; z-index: 900;
        }

        /* MODAL */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-box { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-title { margin: 0 0 20px; font-size: 1.3em; color: var(--secondary); text-align: center; }
        .modal-label { font-size: 0.9em; color: #666; margin-bottom: 5px; display: block; font-weight: 600; margin-top: 10px;}
        .preview-img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; background: #eee; border: 1px solid #ddd;}
        
        /* TABS */
        .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #666; font-weight: 600; }
        .tab.active { color: var(--secondary); border-bottom: 3px solid var(--secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* RANKING */
        .rank-table { width: 100%; border-collapse: collapse; background: white; }
        .rank-table th { background: #333; color: white; padding: 8px; font-size: 0.8em; }
        .rank-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; font-weight: bold; }
        .rank-pos { width: 30px; height: 30px; background: #eee; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin: 0 auto; font-size: 0.9em; }
        .rank-1 .rank-pos { background: #FFD700; color: #000; }
        .rank-2 .rank-pos { background: #C0C0C0; color: #000; }
        .rank-3 .rank-pos { background: #CD7F32; color: #fff; }

        /* APP */
        .status-bar { background: #333; color: white; padding: 8px 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.8em; font-weight: bold; }
        .header-controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; justify-content: center; }
        button.btn-std { border: none; border-radius: 4px; padding: 10px 15px; font-weight: 700; text-transform: uppercase; color: white; cursor: pointer; font-size: 0.85em; width: 100%; }
        .btn-org { background: var(--primary); }
        .btn-blue { background: var(--secondary); }
        .btn-red { background: #d32f2f; }
        .btn-green { background: #2e7d32; }
        .btn-gold { background: #FFD700; color: black; }
        input.inp-std { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 5px; }

        /* TABELA JOGOS */
        .bt-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-bottom: 15px; background: white; border: 1px solid #999; }
        .bt-table th { padding: 8px; border: 1px solid #999; color: black; font-weight: 900; }
        .gh-0 { background: #00b050 !important; color: white !important; }
        .gh-1 { background: #00b0f0 !important; color: black !important; }
        .gh-2 { background: #ffff00 !important; color: black !important; }
        .gh-3 { background: #ff0000 !important; color: white !important; }
        .bt-table td { border: 1px solid #999; padding: 4px; text-align: center; vertical-align: middle; font-weight: 700; }
        .bt-table tr:nth-child(even) { background: #eef; }
        .tbl-input { width: 30px; height: 30px; text-align: center; font-weight: 800; border: 1px solid #aaa; border-radius: 4px; background: white; color: black; }
        .tbl-input:disabled { border: none; background: transparent; }

        .viewer-mode .admin-only { display: none !important; }
        .viewer-mode input:not(.auth-input) { pointer-events: none; border:none; background: transparent; }
        
        .board { display: flex; flex-direction: column; gap: 15px; }
        @media(min-width: 900px) { .board { flex-direction: row; flex-wrap: wrap; } .column { flex: 1 1 40%; } }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; flex-direction: column;}
    </style>
</head>
<body class="viewer-mode">

<div id="loading">
    <div style="font-size:3em;">üéæ</div>
    <b>Carregando...</b>
</div>

<div class="navbar">
    <div class="nav-logo">BT ARENA</div>
    <div class="nav-user" onclick="handleLoginClick()">
        <span id="nav-username" class="user-name">Visitante</span>
        <img id="nav-avatar" class="user-avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png">
    </div>
</div>

<div id="screen-arenas" class="screen active">
    <div class="header-bar">
        <h2 class="section-title">Arenas</h2>
    </div>
    <div id="grid-arenas" class="grid-container"></div>
    <button id="btn-add-arena" class="btn-add-float" onclick="openModal('arena')" style="display:none;">+</button>
    <div style="text-align:center; margin-top:50px; color:#999; font-size:0.8em;" id="msg-login">Toque no √≠cone de usu√°rio para Login.</div>
</div>

<div id="screen-categories" class="screen">
    <div class="back-btn" onclick="showScreen('screen-arenas')"><span class="material-icons">arrow_back</span> Voltar para Arenas</div>
    <div class="header-bar">
        <div>
            <h2 class="section-title" id="title-arena">Nome Arena</h2>
            <div style="font-size:0.8em; color:#777;">Categorias</div>
        </div>
    </div>
    <div id="grid-categories" class="grid-container"></div>
    <button id="btn-add-cat" class="btn-add-float" onclick="openModal('category')" style="display:none;">+</button>
</div>

<div id="screen-tournaments" class="screen">
    <div class="back-btn" onclick="showScreen('screen-categories')"><span class="material-icons">arrow_back</span> Voltar para Categorias</div>
    
    <div class="header-bar">
        <div>
            <h2 class="section-title" id="title-cat">Categoria</h2>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('tournaments')">TORNEIOS</div>
        <div class="tab" onclick="switchTab('ranking')">RANKING</div>
    </div>

    <div id="tab-tournaments" class="tab-content active">
        <div id="grid-tournaments" class="grid-container"></div>
        <button id="btn-add-tourney" class="btn-add-float" onclick="openModal('tournament')" style="display:none;">+</button>
    </div>

    <div id="tab-ranking" class="tab-content">
        <div style="background:white; border-radius:8px; overflow:hidden; border:1px solid #ddd;">
            <table class="rank-table" id="table-ranking"></table>
        </div>
    </div>
</div>

<div id="screen-app" class="screen">
    <div class="status-bar">
        <div onclick="exitApp()" style="cursor:pointer; display:flex; align-items:center;">
            <span class="material-icons" style="font-size:1.1em;">arrow_back</span> Sair
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
            <span class="conn-dot"></span> <span id="app-status">ONLINE</span>
            <button onclick="tryAdmin()" id="btn-lock" style="background:transparent; border:1px solid #aaa; padding:2px 5px; color:white;">üîí</button>
        </div>
    </div>
    <h2 id="t-title-header" style="text-align:center; margin:10px 0; text-transform:uppercase;">Torneio</h2>
    
    <div class="admin-only" style="background:white; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px;">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="text" id="pName" class="inp-std auth-input" style="margin:0;" placeholder="Nome...">
            <button class="btn-std btn-org" style="width:auto;" onclick="addPlayer()">+ Add</button>
            <button class="btn-std btn-blue" style="width:auto;" onclick="addGroup()">+ Grupo</button>
        </div>
        <div style="display:flex; gap:5px; flex-wrap:wrap;">
            <button onclick="setMode('individual')" id="btn-mod-ind" class="btn-std" style="width:auto;">Individual</button>
            <button onclick="setMode('fixed')" id="btn-mod-fix" class="btn-std" style="width:auto;">Fixas</button>
            <button onclick="openFinalsModal()" class="btn-std btn-gold" style="width:auto;">üèÜ Encerrar & Pontuar</button>
            <button onclick="resetT()" class="btn-std btn-red" style="width:auto;">Reset</button>
        </div>
    </div>

    <div class="board">
        <div class="column" id="col-pool" style="background:white; border-radius:8px; border:1px solid #ccc; padding-bottom:10px;">
            <div style="background:var(--secondary); color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between;">
                <span>RESERVAS (<span id="pool-cnt">0</span>)</span>
                <button class="admin-only btn-std" style="background:white; color:var(--secondary); width:auto; padding:2px 8px;" onclick="distribute()">Distribuir</button>
            </div>
            <div id="pool-list" style="padding:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
        </div>
        <div id="groups-container" style="display:contents;"></div>
    </div>
</div>

<div id="modal-overlay">
    <div class="modal-box">
        <h3 class="modal-title" id="modal-h3">Criar</h3>
        <input type="hidden" id="modal-type"> 
        <input type="hidden" id="modal-id"> 
        
        <label class="modal-label" id="lbl-name">Nome</label>
        <input type="text" id="inp-name" class="inp-std auth-input">

        <div id="field-arena" style="display:none;">
            <label class="modal-label">Imagem de Capa</label>
            <img id="img-preview" class="preview-img" src="">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn-std btn-blue" onclick="document.getElementById('file-upload').click()">üìÇ Upload</button>
                <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
            </div>
            <input type="text" id="inp-url" class="inp-std auth-input" placeholder="Ou cole o link..." oninput="updatePreview(this.value)">
        </div>

        <div id="field-category" style="display:none;">
            <label class="modal-label">Estilo</label>
            <select id="inp-cat-type" class="inp-std auth-input">
                <option value="masc">Masculino (Azul)</option>
                <option value="fem">Feminino (Rosa)</option>
                <option value="mista">Mista (Diagonal)</option>
            </select>
            <label class="modal-label">Sigla (Ex: B, C, PRO)</label>
            <input type="text" id="inp-cat-short" class="inp-std auth-input" maxlength="3" style="text-transform:uppercase;">
            
            <label class="modal-label">Pontua√ß√£o do Ranking</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="pts-1" class="inp-std auth-input" placeholder="1¬∫ (100)">
                <input type="number" id="pts-2" class="inp-std auth-input" placeholder="2¬∫ (70)">
                <input type="number" id="pts-3" class="inp-std auth-input" placeholder="3¬∫ (50)">
                <input type="number" id="pts-part" class="inp-std auth-input" placeholder="Part. (10)">
            </div>
        </div>

        <div id="field-pwd" style="display:none;">
            <label class="modal-label">Senha Admin (Opcional)</label>
            <input type="text" id="inp-pwd" class="inp-std auth-input" placeholder="1234">
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-std btn-green" onclick="saveModal()">Salvar</button>
            <button class="btn-std btn-red" onclick="closeModal()">Cancelar</button>
        </div>
    </div>
</div>

<div id="modal-finals" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2100; justify-content:center; align-items:center;">
    <div class="modal-box">
        <h3 class="modal-title">Encerrar & Pontuar</h3>
        <p style="font-size:0.8em; color:#666;">Selecione os vencedores para o Ranking.</p>
        <label class="modal-label">ü•á 1¬∫ Lugar</label><select id="sel-win-1" class="inp-std auth-input"></select>
        <label class="modal-label">ü•à 2¬∫ Lugar</label><select id="sel-win-2" class="inp-std auth-input"></select>
        <label class="modal-label">ü•â 3¬∫ Lugar</label><select id="sel-win-3" class="inp-std auth-input"></select>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-std btn-gold" onclick="submitPoints()">Confirmar</button>
            <button class="btn-std btn-red" onclick="document.getElementById('modal-finals').style.display='none'">Cancelar</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, off, remove, update, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // --- SEU EMAIL (COM PONTO) ---
    const SUPER_ADMIN = "lucas.sibie@gmail.com"; 

    const firebaseConfig = {
        apiKey: "AIzaSyDWWZqUI_afdZWUbEKp9qelddskmpQPxqk",
        authDomain: "beach-tennis-manager-92f17.firebaseapp.com",
        projectId: "beach-tennis-manager-92f17",
        storageBucket: "beach-tennis-manager-92f17.firebasestorage.app",
        messagingSenderId: "311372138486",
        appId: "1:311372138486:web:50c9e403ad877ab094e9d7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    let user = null;
    let curArenaId = null;
    let curCatId = null;
    let curCatData = null;
    let curTourneyId = null;
    let appRef = null;
    let appState = { players:[], groups:[], matches:[], mode:'individual', groupCount:0, pwd:'123', owner:'' };
    let selectedPid = null;

    onAuthStateChanged(auth, (u) => {
        document.getElementById('loading').style.display = 'none';
        user = u;
        if(user) {
            document.getElementById('nav-avatar').src = user.photoURL;
            document.getElementById('nav-username').innerText = user.displayName.split(' ')[0];
            document.getElementById('btn-add-arena').style.display = 'flex'; 
            document.getElementById('msg-login').style.display = 'none';
        } else {
            document.getElementById('nav-avatar').src = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            document.getElementById('nav-username').innerText = "Visitante";
            document.getElementById('btn-add-arena').style.display = 'none';
            document.getElementById('msg-login').style.display = 'block';
        }
        loadArenas(); 
    });

    window.handleLoginClick = async () => {
        if(user) { if(confirm(`Sair da conta ${user.displayName}?`)) signOut(auth); } 
        else { try { await signInWithPopup(auth, googleProvider); } catch(e) { alert("Erro Google: " + e.message); } }
    }

    // --- UTIL ---
    function fixDriveLink(url) {
        if (url && url.includes('drive.google.com') && url.includes('/file/d/')) {
            const id = url.match(/\/d\/(.*?)\//)[1];
            return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        return url;
    }

    // --- MODAL & IMAGE LOGIC ---
    window.openModal = (type, id='', name='', extra1='', extra2='') => {
        const titleMap = { 'arena': 'Arena', 'category': 'Categoria', 'tournament': 'Torneio' };
        document.getElementById('modal-h3').innerText = (id ? 'Editar ' : 'Nova ') + titleMap[type];
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('modal-type').value = type;
        document.getElementById('modal-id').value = id;
        document.getElementById('inp-name').value = name;

        document.getElementById('field-arena').style.display = 'none';
        document.getElementById('field-category').style.display = 'none';
        document.getElementById('field-pwd').style.display = 'none';

        if(type === 'arena') {
            document.getElementById('field-arena').style.display = 'block';
            document.getElementById('inp-url').value = extra1; 
            document.getElementById('img-preview').src = extra1 || 'https://via.placeholder.com/150';
        } else if(type === 'category') {
            document.getElementById('field-category').style.display = 'block';
        } else if(type === 'tournament') {
            document.getElementById('field-pwd').style.display = 'block';
            document.getElementById('inp-pwd').value = extra1 || "1234";
        }
    }

    window.closeModal = () => { document.getElementById('modal-overlay').style.display = 'none'; }
    window.updatePreview = (url) => { document.getElementById('img-preview').src = fixDriveLink(url); }

    window.handleFileSelect = (input) => {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');
                const scale = 500 / img.width;
                cvs.width = 500; cvs.height = img.height * scale;
                ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                const data = cvs.toDataURL('image/jpeg', 0.7);
                document.getElementById('inp-url').value = data;
                updatePreview(data);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    window.saveModal = () => {
        if(!user) return;
        const type = document.getElementById('modal-type').value;
        const id = document.getElementById('modal-id').value;
        const name = document.getElementById('inp-name').value.trim();
        if(!name) return alert("Nome obrigat√≥rio");

        let path = '';
        let data = { name, owner: user.uid };

        if (type === 'arena') {
            path = 'arenas';
            data.img = document.getElementById('inp-url').value;
        } else if (type === 'category') {
            path = `categories/${curArenaId}`;
            data.type = document.getElementById('inp-cat-type').value;
            data.short = document.getElementById('inp-cat-short').value.toUpperCase();
            data.points = {
                p1: parseInt(document.getElementById('pts-1').value)||0,
                p2: parseInt(document.getElementById('pts-2').value)||0,
                p3: parseInt(document.getElementById('pts-3').value)||0,
                part: parseInt(document.getElementById('pts-part').value)||0
            };
        } else if (type === 'tournament') {
            path = `tournaments_meta/${curCatId}`;
            data.pwd = document.getElementById('inp-pwd').value || "1234";
            data.date = Date.now();
        }

        if (id) { update(ref(db, `${path}/${id}`), data); } 
        else {
            data.createdAt = Date.now();
            const newRef = push(ref(db, path), data);
            if(type === 'tournament') {
                set(ref(db, `tournaments_data/${newRef.key}`), {
                    mode: 'individual', players:[], groups:[], matches:[], groupCount:0, pwd: data.pwd, owner: user.uid
                });
            }
        }
        closeModal();
    }

    // --- NAVIGATION ---
    window.switchTab = (tabName) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if(tabName === 'tournaments') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('tab-tournaments').classList.add('active');
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('tab-ranking').classList.add('active');
            loadRanking();
        }
    }
    window.showScreen = (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- LOADERS ---
    function loadArenas() {
        onValue(ref(db, 'arenas'), (snap) => {
            const list = document.getElementById('grid-arenas'); list.innerHTML = '';
            const data = snap.val();
            if(!data) return; 
            Object.keys(data).forEach(key => {
                const d = data[key];
                const isOwner = user && (user.uid === d.owner || user.email === SUPER_ADMIN);
                list.appendChild(createCard(key, d.name, d.img, isOwner, 'arena', () => enterArena(key, d)));
            });
        });
    }

    function createCard(id, name, imgOrClass, isOwner, type, onClick, subtitle='') {
        const div = document.createElement('div');
        div.className = 'std-card';
        let content = '';
        if(type === 'category') {
            const bgClass = `bg-${imgOrClass.type}`;
            content = `<div class="cat-card-content ${bgClass}">${imgOrClass.short}</div>`;
        } else {
            content = `<img src="${imgOrClass || 'https://via.placeholder.com/300'}" class="card-img">`;
        }
        div.innerHTML = `${content}<div class="card-overlay"><div class="card-title">${name}</div>${subtitle ? `<div class="card-subtitle">${subtitle}</div>` : ''}</div>${isOwner ? `<div class="card-actions"><div class="btn-icon-circle" onclick="openModal('${type}', '${id}', '${name.replace(/'/g,"\\'")}', '${(type==='arena'?imgOrClass:'')}'); event.stopPropagation()">‚úé</div><div class="btn-icon-circle" style="color:red;" onclick="deleteItem('${type}', '${id}'); event.stopPropagation()">‚úï</div></div>` : ''}`;
        div.onclick = onClick;
        return div;
    }

    window.enterArena = (id, data) => {
        curArenaId = id;
        document.getElementById('title-arena').innerText = data.name;
        document.getElementById('btn-add-cat').style.display = user ? 'flex' : 'none';
        showScreen('screen-categories');
        loadCategories(id);
    }

    function loadCategories(arenaId) {
        onValue(ref(db, `categories/${arenaId}`), (snap) => {
            const list = document.getElementById('grid-categories'); list.innerHTML = '';
            const data = snap.val();
            if(!data) { list.innerHTML = '<div style="color:#999; grid-column:1/-1; text-align:center;">Nenhuma categoria.</div>'; return; }
            Object.keys(data).forEach(key => {
                const d = data[key];
                const isOwner = user && (user.uid === d.owner || user.email === SUPER_ADMIN);
                list.appendChild(createCard(key, d.name, {type: d.type, short: d.short}, isOwner, 'category', () => enterCategory(key, d)));
            });
        });
    }

    window.enterCategory = (id, data) => {
        curCatId = id;
        curCatData = data;
        document.getElementById('title-cat').innerText = data.name;
        document.getElementById('btn-add-tourney').style.display = user ? 'flex' : 'none';
        switchTab('tournaments');
        showScreen('screen-tournaments');
        loadTournaments(id);
    }

    function loadTournaments(catId) {
        onValue(ref(db, `tournaments_meta/${catId}`), (snap) => {
            const list = document.getElementById('grid-tournaments'); list.innerHTML = '';
            const data = snap.val();
            if(!data) { list.innerHTML = '<div style="color:#999; grid-column:1/-1; text-align:center;">Nenhum torneio.</div>'; return; }
            Object.keys(data).forEach(key => {
                const d = data[key];
                const isOwner = user && (user.uid === d.owner || user.email === SUPER_ADMIN);
                const sub = new Date(d.date).toLocaleDateString('pt-BR') + (d.finished ? ' (Finalizado)' : '');
                list.appendChild(createCard(key, d.name, null, isOwner, 'tournament', () => enterApp(key, d.name, d.pwd, d.owner), sub));
            });
        });
    }

    function loadRanking() {
        onValue(ref(db, `rankings/${curCatId}`), (snap) => {
            const table = document.getElementById('table-ranking');
            table.innerHTML = '<tr><th>#</th><th>Nome</th><th>Pts</th><th>J</th><th>V</th></tr>';
            const data = snap.val();
            if(!data) { table.innerHTML += '<tr><td colspan="5" style="padding:20px; color:#999;">Sem ranking.</td></tr>'; return; }
            const rankArr = Object.values(data).sort((a,b) => b.points - a.points);
            rankArr.forEach((p, i) => {
                const tr = document.createElement('tr');
                tr.className = `rank-${i+1}`;
                tr.innerHTML = `<td><div class="rank-pos">${i+1}</div></td><td style="text-align:left;">${p.name}</td><td style="color:var(--primary); font-size:1.1em;">${p.points}</td><td style="color:#777;">${p.tournaments || 0}</td><td style="color:#777;">${p.wins || 0}</td>`;
                table.appendChild(tr);
            });
        });
    }

    window.enterApp = (tId, name, pwd, ownerId) => {
        curTourneyId = tId;
        document.getElementById('t-title-header').innerText = name;
        showScreen('screen-app');
        const isOwner = user && (user.uid === ownerId || user.email === SUPER_ADMIN);
        if(isOwner) { document.body.classList.remove('viewer-mode'); document.getElementById('btn-lock').innerText = 'üîì'; } 
        else { document.body.classList.add('viewer-mode'); document.getElementById('btn-lock').innerText = 'üîí'; }
        if(appRef) off(appRef);
        appRef = ref(db, `tournaments_data/${tId}`);
        document.getElementById('loading').style.display = 'flex';
        onValue(appRef, (snap) => {
            document.getElementById('loading').style.display = 'none';
            const d = snap.val();
            if(d) { appState = d; ['players','groups','matches'].forEach(k => {if(!appState[k]) appState[k]=[]}); }
            else { appState = {mode:'individual',players:[],groups:[],matches:[],groupCount:0, pwd:pwd, owner:ownerId}; }
            renderApp();
        });
    }

    window.exitApp = () => { if(appRef) off(appRef); showScreen('screen-tournaments'); }
    
    // --- RANKING LOGIC ---
    window.openFinalsModal = () => {
        document.getElementById('modal-finals').style.display = 'flex';
        const fills = [document.getElementById('sel-win-1'), document.getElementById('sel-win-2'), document.getElementById('sel-win-3')];
        fills.forEach(s => {
            s.innerHTML = '<option value="">Selecione...</option>';
            appState.players.forEach(p => s.innerHTML += `<option value="${p.name}">${p.name}</option>`);
        });
    }

    window.submitPoints = async () => {
        if(!curCatData || !curCatData.points) return alert("Erro na config da categoria.");
        const p1 = document.getElementById('sel-win-1').value;
        const p2 = document.getElementById('sel-win-2').value;
        const p3 = document.getElementById('sel-win-3').value;
        if(!p1) return alert("Selecione o campe√£o.");
        update(ref(db, `tournaments_meta/${curCatId}/${curTourneyId}`), { finished: true });
        const rankRef = ref(db, `rankings/${curCatId}`);
        const snap = await get(rankRef);
        let ranking = snap.val() || {};
        const updatePlayer = (name, pts, isWin=false) => {
            const key = name.replace(/[.#$/[\]]/g, ""); 
            if(!ranking[key]) ranking[key] = { name: name, points: 0, tournaments: 0, wins: 0 };
            ranking[key].points += pts;
            ranking[key].tournaments += 1;
            if(isWin) ranking[key].wins += 1;
        }
        if(p1) updatePlayer(p1, curCatData.points.p1, true);
        if(p2) updatePlayer(p2, curCatData.points.p2);
        if(p3) updatePlayer(p3, curCatData.points.p3);
        appState.players.forEach(p => {
            if(p.name !== p1 && p.name !== p2 && p.name !== p3) updatePlayer(p.name, curCatData.points.part);
        });
        await set(rankRef, ranking);
        alert("Ranking Atualizado!");
        document.getElementById('modal-finals').style.display = 'none';
    }

    // --- STANDARD APP LOGIC ---
    window.tryAdmin = () => { if(!document.body.classList.contains('viewer-mode')) return; const p = prompt("Senha:"); if(p === appState.pwd || (user && user.email === SUPER_ADMIN)) { document.body.classList.remove('viewer-mode'); document.getElementById('btn-lock').innerText = 'üîì'; } else alert("Senha incorreta"); }
    window.deleteItem = (type, id) => { if(confirm("Apagar?")) { if(type==='arena'){remove(ref(db, `arenas/${id}`)); remove(ref(db, `categories/${id}`));} else if(type==='category'){remove(ref(db, `categories/${curArenaId}/${id}`)); remove(ref(db, `tournaments_meta/${id}`));} else {remove(ref(db, `tournaments_meta/${curCatId}/${id}`)); remove(ref(db, `tournaments_data/${id}`));} } }
    function save() { if(appRef) set(appRef, appState); }
    const pInput = document.getElementById('pName'); if(pInput) pInput.addEventListener('keypress', (e)=>{if(e.key==='Enter') window.addPlayer()});
    window.addPlayer = () => { const n=document.getElementById('pName').value.trim(); if(!n)return; appState.players.push({id:'p'+Date.now(), name:n, groupId:'pool', games:0, wins:0, bal:0, pts:0}); document.getElementById('pName').value=''; document.getElementById('pName').focus(); save(); }
    window.addGroup = () => { appState.groupCount++; appState.groups.push({id:'g'+Date.now(), name: "GRUPO "+String.fromCharCode(64+appState.groupCount)}); save(); }
    window.setMode = (m) => { if(appState.players.length && !confirm("Mudar?"))return; appState.mode=m; save(); }
    window.resetT = () => { if(confirm("Zerar?")) { appState.players=[]; appState.groups=[]; appState.matches=[]; appState.groupCount=0; save(); } }
    window.toggleSel = (pid,e) => { if(document.body.classList.contains('viewer-mode'))return; e.stopPropagation(); selectedPid = selectedPid===pid?null:pid; renderApp(); }
    window.moveSel = (gid) => { if(!selectedPid)return; const p=appState.players.find(x=>x.id===selectedPid); if(p){p.groupId=gid; selectedPid=null; recalc(); save();} }
    window.distribute = () => { const pool=appState.players.filter(p=>p.groupId==='pool'); if(!pool.length||!confirm("Distribuir?"))return; pool.forEach(p=>{ appState.groups.sort((a,b)=>appState.players.filter(x=>x.groupId===a.id).length - appState.players.filter(x=>x.groupId===b.id).length); if(appState.groups.length) p.groupId=appState.groups[0].id; }); save(); }
    window.delGroup = (gid) => { if(confirm("Excluir?")) { appState.players.forEach(p=>{if(p.groupId===gid)p.groupId='pool'}); appState.groups=appState.groups.filter(g=>g.id!==gid); appState.matches=appState.matches.filter(m=>m.gid!==gid); save(); }}
    window.delPlayer = (pid) => { if(confirm("Excluir?")) { appState.players=appState.players.filter(p=>p.id!==pid); save(); }}
    window.genMatches = (gid) => {
        const ps=appState.players.filter(p=>p.groupId===gid);
        if(appState.mode==='individual' && ps.length<4) return alert("Min 4");
        let hist=new Set(); appState.matches.filter(m=>m.gid===gid && m.saved).forEach(m=>{ if(appState.mode==='fixed') hist.add([m.p1,m.p3].sort().join('-')); else { hist.add([m.p1,m.p2].sort().join('-')); hist.add([m.p3,m.p4].sort().join('-')); } });
        if(appState.mode==='fixed') { for(let i=0;i<ps.length;i++) for(let j=i+1;j<ps.length;j++) { const k=[ps[i].id,ps[j].id].sort().join('-'); if(!hist.has(k)) addM(gid, ps[i].id, 'd', ps[j].id, 'd'); } } 
        else if(ps.length===5) { if(appState.matches.filter(m=>m.gid===gid).length && !confirm("Rodada 5?")) return; [[0,1,2,3],[0,2,3,4],[0,3,1,4],[0,4,1,2],[1,3,2,4]].forEach(r=>addM(gid, ps[r[0]].id, ps[r[1]].id, ps[r[2]].id, ps[r[3]].id)); } 
        else { let pairs=[]; for(let i=0;i<ps.length;i++) for(let j=i+1;j<ps.length;j++) { const k=[ps[i].id,ps[j].id].sort().join('-'); if(!hist.has(k)) pairs.push({p1:ps[i].id, p2:ps[j].id}); } if(!pairs.length) return alert("Sem combina√ß√µes."); pairs.sort(()=>Math.random()-0.5); let count=0; while(pairs.length) { let pA=pairs[0], found=false; for(let k=1; k<pairs.length; k++) { let pB=pairs[k], all=new Set([pA.p1,pA.p2,pB.p1,pB.p2]); if(all.size===4) { addM(gid,pA.p1,pA.p2,pB.p1,pB.p2); pairs.splice(k,1); pairs.splice(0,1); found=true; count++; break; } } if(!found) pairs.splice(0,1); } if(!count) alert("N√£o consegui casar."); }
        save();
    }
    function addM(gid,p1,p2,p3,p4) { appState.matches.push({mid:'m'+Date.now()+Math.random(), gid, p1,p2,p3,p4, s1:'', s2:'', saved:false}); }
    window.addManual = (gid) => { const ps=appState.players.filter(p=>p.groupId===gid); if(ps.length<2) return alert("Poucos jogadores"); addM(gid, ps[0].id, ps[0].id, ps[0].id, ps[0].id); save(); }
    window.saveS = (mid) => { const m = appState.matches.find(x=>x.mid===mid), s1=document.getElementById(`s1-${mid}`).value, s2=document.getElementById(`s2-${mid}`).value; if(m.saved) { m.saved=false; } else { if(s1===''||s2==='') return; m.s1=parseInt(s1); m.s2=parseInt(s2); m.saved=true; } recalc(); save(); }
    window.delM = (mid) => { if(confirm("Excluir?")) { appState.matches=appState.matches.filter(m=>m.mid!==mid); recalc(); save(); } }
    function recalc() { appState.players.forEach(p=>{p.games=0; p.wins=0; p.bal=0; p.pts=0;}); appState.matches.forEach(m=>{ if(m.saved) { const run = (id,my,op) => { const pl=appState.players.find(x=>x.id===id); if(pl){pl.games++; pl.bal+=my-op; if(my>op){pl.wins++; pl.pts+=3;}} }; run(m.p1,m.s1,m.s2); run(m.p3,m.s2,m.s1); if(appState.mode==='individual'){ run(m.p2,m.s1,m.s2); run(m.p4,m.s2,m.s1); } } }); }
    function renderApp() {
        document.getElementById('btn-mod-ind').style.background = appState.mode==='individual'?'var(--secondary)':'#ccc';
        document.getElementById('btn-mod-fix').style.background = appState.mode==='fixed'?'var(--secondary)':'#ccc';
        const pl = document.getElementById('pool-list'); pl.innerHTML=''; const poolPs = appState.players.filter(p=>p.groupId==='pool'); document.getElementById('pool-cnt').innerText = poolPs.length;
        poolPs.forEach(p => { const d = document.createElement('div'); d.className=`std-card ${selectedPid===p.id?'selected':''}`; d.style.padding='10px'; d.style.aspectRatio='auto'; d.onclick=(e)=>window.toggleSel(p.id,e); d.innerHTML = `<span>${p.name}</span> <b style="color:red; float:right;" class="admin-only" onclick="delPlayer('${p.id}');event.stopPropagation()">‚úï</b>`; pl.appendChild(d); });
        const gc = document.getElementById('groups-container'); gc.innerHTML='';
        appState.groups.forEach((g,i) => {
            const ps = appState.players.filter(p=>p.groupId===g.id).sort((a,b)=> b.pts-a.pts || b.wins-a.wins || b.bal-a.bal);
            const ms = appState.matches.filter(m=>m.gid===g.id);
            const col = document.createElement('div'); col.className='column';
            let h = `<div onclick="moveSel('${g.id}')" style="cursor:pointer; margin-bottom:5px;"><div class="admin-only" style="display:flex; gap:5px;"><button class="btn-std btn-green" onclick="genMatches('${g.id}'); event.stopPropagation()">‚ö° Auto</button><button class="btn-std btn-blue" onclick="addManual('${g.id}'); event.stopPropagation()">üñê</button></div></div>`;
            if(ms.length) {
                h += `<table class="bt-table"><thead><tr><th colspan="7" class="gh-${i%4}" onclick="moveSel('${g.id}')">${g.name} <span class="admin-only" onclick="delGroup('${g.id}'); event.stopPropagation()" style="float:right; cursor:pointer;">‚úï</span></th></tr></thead><tbody>`;
                ms.forEach(m => {
                    const n = (id) => appState.players.find(x=>x.id===id)?.name || '?';
                    const t1 = appState.mode==='fixed' ? n(m.p1) : `${n(m.p1)}<br><small>/${n(m.p2)}</small>`;
                    const t2 = appState.mode==='fixed' ? n(m.p3) : `${n(m.p3)}<br><small>/${n(m.p4)}</small>`;
                    h += `<tr><td style="text-align:right">${t1}</td><td></td><td style="padding:0"><input type="tel" id="s1-${m.mid}" value="${m.s1}" class="tbl-input auth-input" ${m.saved?'disabled':''}></td><td>x</td><td style="padding:0"><input type="tel" id="s2-${m.mid}" value="${m.s2}" class="tbl-input auth-input" ${m.saved?'disabled':''}></td><td></td><td style="text-align:left">${t2}</td><td class="admin-only" style="width:40px"><button class="btn-ok-mini ${m.saved?'saved':''}" onclick="saveS('${m.mid}')">${m.saved?'‚úé':'OK'}</button>${!m.saved ? `<div style="color:red; cursor:pointer" onclick="delM('${m.mid}')">‚úï</div>` : ''}</td></tr>`;
                });
                h += `</tbody></table>`;
            } else { h += `<div class="gh-${i%4}" style="padding:10px; font-weight:bold; text-align:center; color:white; border-radius:4px;" onclick="moveSel('${g.id}')">${g.name} (Vazio)</div>`; }
            if(ps.length) { h += `<table class="bt-table" style="margin-top:0; border-top:none;"><tr style="background:#333; color:white"><td colspan="6" style="padding:2px; font-size:0.7em">CLASSIFICA√á√ÉO</td></tr><tr style="background:#ccc; font-size:0.7em"><td>#</td><td>Nome</td><td>J</td><td>V</td><td>S</td><td>Pts</td></tr>`; ps.forEach((p,ix) => h += `<tr style="font-size:0.8em"><td>${ix+1}</td><td style="text-align:left">${p.name}</td><td>${p.games}</td><td>${p.wins}</td><td>${p.bal}</td><td>${p.pts}</td></tr>`); h += `</table>`; }
            col.innerHTML = h; gc.appendChild(col);
        });
    }
</script>
</body>
</html>
